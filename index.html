<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wi-Fi Portal - Snookum ISP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Mobile-friendly card transitions */
        .package-card { transition: all 0.2s ease-in-out; border-radius: 12px; border: 2px solid #e2e8f0; cursor: pointer; }
        .package-card.selected { border-color: #2563eb; background-color: #eff6ff; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .btn-primary { background-color: #2563eb; transition: all 0.2s; }
        .btn-primary:active { transform: scale(0.98); opacity: 0.9; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; margin-left: 8px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Prevent auto-zoom on mobile inputs */
        input { font-size: 16px !important; }
    </style>
</head>
<body class="bg-[#f8fafc] font-sans text-gray-800 antialiased">

    <div class="max-w-4xl mx-auto px-4 py-6 md:py-12">
        <div class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-black text-blue-900 mb-2 tracking-tight">SMARTECH</h1>
            <div class="inline-flex items-center px-3 py-1 rounded-full bg-green-100 text-green-700 text-xs font-bold uppercase tracking-wide">
                <span class="mr-2 h-2 w-2 rounded-full bg-green-500 animate-pulse"></span>
                M-PESA STK PUSH ACTIVE
            </div>
        </div>

        <div class="mb-10">
            <h2 class="text-lg font-bold text-blue-900 mb-4 text-center md:text-left">Step 1: Select your Internet Plan</h2>
            <div id="package-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        </div>

        <div class="max-w-md mx-auto mb-8 bg-white p-6 rounded-2xl border border-blue-50 shadow-lg">
            <h2 class="text-center font-bold text-blue-900 mb-4 uppercase text-xs tracking-widest">Step 2: Enter M-Pesa Number</h2>
            <div class="space-y-4">
                <input type="tel" id="phone" placeholder="07xx... or 254..." 
                       class="w-full p-4 border border-gray-200 rounded-xl text-center text-lg shadow-inner focus:ring-2 focus:ring-blue-500 outline-none transition-all bg-gray-50">
                
                <button onclick="initiatePayHeroSTK()" id="payBtn" class="w-full btn-primary text-white py-4 rounded-xl font-bold text-lg shadow-md uppercase tracking-wide">
                    Pay via M-Pesa
                </button>
            </div>
        </div>

        <div class="max-w-md mx-auto bg-white p-6 rounded-2xl border border-blue-50 shadow-lg">
            <h2 class="text-center font-bold text-blue-900 mb-4 uppercase text-xs tracking-widest text-slate-500">Already have a code?</h2>
            <div class="flex flex-col sm:flex-row gap-3">
                <input type="text" id="accessCode" placeholder="ENTER CODE" 
                       class="flex-1 p-4 rounded-xl border border-gray-200 text-center font-mono text-lg uppercase tracking-widest outline-none focus:border-blue-500 bg-gray-50">
                <button onclick="connectToWifi()" id="connectBtn" class="btn-primary text-white py-4 px-6 rounded-xl font-bold shadow-md uppercase">
                    Connect
                </button>
            </div>
            <p id="statusMsg" class="text-center mt-4 text-sm font-semibold min-h-[20px]"></p>
        </div>
    </div>

    <footer class="mt-auto py-8 border-t border-blue-50 bg-white">
        <div class="max-w-6xl mx-auto px-4 text-center">
            <p class="text-slate-400 text-sm font-medium">
                &copy; 2026 SMARTECH. All Rights Reserved.
            </p>
            <p class="mt-2 text-slate-500 text-xs tracking-wide uppercase">
                Developed by 
                <a href="https://mrsnookum.github.io/Brighton-Portfolio/" 
                   target="_blank" 
                   rel="noopener noreferrer" 
                   class="font-bold text-blue-600 hover:text-blue-800 transition-colors duration-200">
                   Brighton the Dev
                </a>
            </p>
        </div>
    </footer>

    <script>
        // Updated URL for your Apps Script deployment
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxCZ_myNjhr9dXk66qH5PTbeJzKqrEa_vT5NK-jhV6HTx4OmPqVONbV-4g9ZVB5wBc/exec';
        let selectedPackage = null;

        const packages = [
            { name: "1 Hour Access", desc: "Access for 1 hour", price: 1 },
            { name: "2 Hour Access", desc: "Access for 2 hours", price: 15 },
            { name: "12 Hour Unlimited", desc: "Unlimited for 12 hours", price: 30 },
            { name: "1 Day Unlimited", desc: "Unlimited for 24 hours", price: 50 },
            { name: "3GB Daily", desc: "3GB valid for 24 hours", price: 60 },
            { name: "4GB Daily", desc: "4GB valid for 24 hours", price: 70 },
            { name: "5GB - 3 Days", desc: "5GB valid for 3 days", price: 100 },
            { name: "10GB - 7 Days", desc: "10GB valid for 7 days", price: 150 },
            { name: "1 Week Unlimited", desc: "Unlimited for 7 days", price: 200 },
            { name: "Weekend Unlimited", desc: "Fri - Sun access", price: 250 },
            { name: "2 Weeks Unlimited", desc: "14 days access", price: 500 },
            { name: "1 Month Unlimited", desc: "30 days access", price: 850 }
        ];

        // Render Packages
        const container = document.getElementById('package-container');
        packages.forEach(pkg => {
            const cardId = `pkg-${pkg.name.replace(/\s+/g, '')}`;
            container.innerHTML += `
                <div id="${cardId}" class="package-card bg-white p-4 text-center shadow-sm" onclick="selectPkg('${pkg.name}', ${pkg.price}, '${cardId}')">
                    <h3 class="text-lg font-bold text-blue-900">${pkg.name}</h3>
                    <p class="text-gray-400 text-xs mb-2">${pkg.desc}</p>
                    <p class="text-xl font-black text-gray-900 mb-1 font-mono">KES ${pkg.price}</p>
                    <div class="text-[10px] font-bold text-blue-400 uppercase tracking-widest">Select Plan</div>
                </div>
            `;
        });

        function selectPkg(name, price, id) {
            selectedPackage = { name, price };
            document.querySelectorAll('.package-card').forEach(c => c.classList.remove('selected'));
            document.getElementById(id).classList.add('selected');
            document.getElementById('phone').scrollIntoView({ behavior: 'smooth', block: 'center' });
            updateStatus(`Selected: ${name}.`, "blue");
        }

        async function initiatePayHeroSTK() {
            const phoneInput = document.getElementById('phone').value.trim();
            if (!selectedPackage) return updateStatus("Select a package first!", "red");
            if (!phoneInput || phoneInput.length < 10) return updateStatus("Enter valid phone number.", "red");

            updateStatus("Processing PIN prompt... <div class='loader'></div>", "blue");

            try {
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: "POST",
                    body: JSON.stringify({ 
                        action: "registerPayment", 
                        phone: phoneInput, 
                        package: selectedPackage.name 
                    })
                });
                
                const result = await response.json();
                if(result.status === "success") {
                    updateStatus("Check phone for PIN prompt!", "green");
                    pollForCode(phoneInput);
                } else {
                    updateStatus("STK Error: " + (result.message || "Try again"), "red");
                }
            } catch (e) {
                updateStatus("Connection error. Try again.", "red");
            }
        }

        async function pollForCode(phone) {
            const codeInput = document.getElementById('accessCode');
            const cleanPhone = phone.toString().slice(-9); 
            const startTime = Date.now();
            
            const interval = setInterval(async () => {
                if (Date.now() - startTime > 180000) { 
                    clearInterval(interval);
                    updateStatus("Timeout. Enter code manually if paid.", "red");
                    return;
                }

                try {
                    const response = await fetch(`${APPS_SCRIPT_URL}?action=checkMyCode&phone=${cleanPhone}`);
                    const result = await response.json();
                    
                    if (result.status === "success") {
                        clearInterval(interval); 
                        codeInput.value = result.code;
                        updateStatus("Payment Verified! Connecting...", "green");
                        setTimeout(() => connectToWifi(), 1500); 
                    }
                } catch (e) { console.log("Waiting..."); }
            }, 4000); 
        }

        async function connectToWifi() {
            const codeInput = document.getElementById('accessCode').value.trim().toUpperCase();
            const urlParams = new URLSearchParams(window.location.search);
            const mac = urlParams.get('mac') || "00:00:00:00:00:00"; 
            
            if (!codeInput) return updateStatus("Please enter your access code.", "red");
            updateStatus("Connecting... <div class='loader'></div>", "blue");
            
            try {
                const resp = await fetch(APPS_SCRIPT_URL, {
                    method: "POST",
                    body: JSON.stringify({ action: "verifyAndConnect", code: codeInput, mac: mac })
                });
                const data = await resp.json();
                
                if (data.status === "success") {
                    updateStatus("AUTHENTICATED! Redirecting...", "green");
                    setTimeout(() => { window.location.href = "https://www.google.com"; }, 2000);
                } else {
                    updateStatus(data.message || "Invalid Code.", "red");
                }
            } catch (e) {
                updateStatus("Connection error.", "red");
            }
        }

        function updateStatus(msg, color) {
            const status = document.getElementById('statusMsg');
            status.innerHTML = msg;
            status.style.color = color === "red" ? "#ef4444" : (color === "green" ? "#22c55e" : "#2563eb");
        }
    </script>
</body>
</html>
